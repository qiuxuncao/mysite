{% extends 'base.html' %}
{% load staticfiles %}
{% block title %}POST ARTICLE{% endblock %}
{% block content %} 
<div style="margin-left:10px">
    <form class ="form-hoizontal" action ="." method ="post" enctype="multipart/form-data">{% csrf_token %}
        <div class="form-group">
            <label for="avatar">标题图</label>
            <input type="file" class="form-control-file" name="avatar" id="avatar">
        </div>

    <div class ="row" style="margin-top: 10px;">
        <div class="col-md-2 text-right "><span>标题：</span></div>
        <div class="col-md-10 text-left ">{{article_post_form.title}}</div>
    </div>

    <div class ="row" style=" margin-top: 10px;">
        <div class="col-md-2 text-right"><span>栏目：</span></div>
        <div class="col-md-10 text-left">
            <select id="which_column">
                {% for column in article_columns %}
                <option value=" {{column.id }}">{{column.column}}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="row" style="margin-top: 10px">
        <div class="col-md-2 text-right"><span>标签：</span></div>
        <div class="col-md-10 text-left">
            {% for tag in article_tags %}
            <input type="checkbox" value="{{ tag.tag }}">{{ tag.tag }}</input>
            {% endfor %}
        </div>
    </div>

    <div class ="row" style="margin-top:10px;">
        <div class=" col-md-2 text-right"><span >内容：</span></div>
        <div id="editormd" class=" col-md-10 text-left ">
            <textarea style="display: none;" id="id_body"></textarea>
        </div>
    </div>
    <div class ="row">
        <input type="button" class="btn btn-primary btn-lg" value="发布" onclick="publish_article();ajaxFileUpload()">
    </div>
</form>
</div> 

    <script type="text/javascript" src='{% static "js/jquery.js"%}'></script>
    <script type="text/javascript" src="{% static 'js/layer.js'%}"></script>
    <script type="text/javascript" src="{% static 'editor/editormd.min.js' %}"></script>
    <script type="text/javascript" src="{% static "js/ajaxfileupload.js" %}"></script>
    <script type="text/javascript">
        $(function () {
            var editor = editormd("editormd",{
                width:"100%",
                height:640,
                syncScrolling:"single",
                path:"{% static 'editor/lib/' %}"
            });
        });
    </script>
    <link rel="stylesheet" href="{% static 'editor/css/style.css' %}">
    <link rel="stylesheet" href="{% static 'editor/css/editormd.css' %}">
    <script type ="text/javascript">

        function publish_article(){
            {#此处的id=id_title是表单生成的，代码并没有编写此属性#}
            var title= $("#id_title").val();
            var column_id = $("#which_column").val();
            var body = $("#id_body").val();
            var img = $("#avatar").val();
            $.ajax({
                url:"{% url 'article:article_post' %}",
                type:"POST",
                data:{'title':title, 'body': body, 'column_id': column_id},
                success:function (e) {
                    if(e=='1'){
                        layer.msg("成功发布");
                        location.href = "{% url 'article:article_list' %}";
                    }else if(e=='2'){
                        layer.msg("sorry");
                    } else{
                        layer.msg("项目名和内容必须填写");
                    }
                },
            });
        }
        </script>

     <!-- 执行上传文件操作的函数 -->
      <script type="text/javascript">
          function ajaxFileUpload(){
              var formData = new FormData();
                formData.append('file', $('#avatar')[0].files[0]);  //添加图片信息的参数
                formData.append('sizeid',123);  //添加其他参数
               $.ajaxFileUpload(
                   {
                url:"{% url 'article:article_post' %}",            //需要链接到服务器地址
                secureuri:false,

                data: formData,
                {#fileElementId:'avatar',                        //文件选择框的id属性#}
                dataType: 'json',                                     //服务器返回的格式，可以是json
                success: function (data, status)            //相当于java中try语句块的用法
                {
                    $('#result').html('添加成功');
                },
                error: function (data, status, e)            //相当于java中catch语句块的用法
                {
                    $('#result').html('添加失败');
                }
            }

               );

          }
      </script>
{% endblock %}